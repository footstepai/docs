{
  "openapi": "3.1.0",
  "info": {
    "title": "Footstep Routing API",
    "description": "Terrain-intelligent routing, elevation, and spatial analysis. Every response includes terrain analytics by default. All responses use self-documenting field names (distance_m, duration_s, grade_percent) and support two formats: footstep (default, compact) and geojson (standard GeoJSON).",
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "https://api.footstep.ai",
      "description": "Production"
    }
  ],
  "security": [
    {
      "apiKey": []
    }
  ],
  "paths": {
    "/v1/routing/route": {
      "post": {
        "operationId": "calculateRoute",
        "summary": "Calculate a route with terrain analysis",
        "description": "Calculate a route between two or more locations. Returns turn-by-turn directions with terrain analytics (ascent, descent, grade, difficulty) included by default. All distances are in meters, durations in seconds.",
        "tags": ["Routing"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/RouteRequest" },
              "examples": {
                "minimal": {
                  "summary": "Just coordinates",
                  "value": {
                    "locations": [
                      { "lat": 51.5322, "lon": -0.1240 },
                      { "lat": 51.5055, "lon": -0.0754 }
                    ]
                  }
                },
                "with_options": {
                  "summary": "Pedestrian with hill avoidance",
                  "value": {
                    "locations": [
                      { "lat": 51.5322, "lon": -0.1240 },
                      { "lat": 51.5055, "lon": -0.0754 }
                    ],
                    "costing": "pedestrian",
                    "costing_options": { "pedestrian": { "use_hills": 0.2 } },
                    "elevation_interval": 20
                  }
                },
                "geojson": {
                  "summary": "GeoJSON format",
                  "value": {
                    "locations": [
                      { "lat": 51.5322, "lon": -0.1240 },
                      { "lat": 51.5055, "lon": -0.0754 }
                    ],
                    "format": "geojson"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Route with terrain analytics",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/RouteResponse" } },
              "application/geo+json": { "schema": { "type": "object", "description": "GeoJSON FeatureCollection where each leg is a Feature with LineString geometry. Route-level summary in top-level properties." } }
            }
          },
          "400": { "description": "Invalid request", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "503": { "description": "Routing engine unavailable", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/v1/routing/elevation": {
      "post": {
        "operationId": "getElevation",
        "summary": "Get elevation data for points or a path",
        "description": "Query elevation values for coordinates or an encoded polyline. Returns height values with a computed summary including ascent, descent, min/max/avg elevation.",
        "tags": ["Analysis"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/ElevationRequest" },
              "examples": {
                "points": {
                  "summary": "Elevation for specific points",
                  "value": {
                    "shape": [
                      { "lat": 51.5322, "lon": -0.1240 },
                      { "lat": 51.5007, "lon": -0.1246 },
                      { "lat": 51.5055, "lon": -0.0754 }
                    ]
                  }
                },
                "range": {
                  "summary": "Distance-elevation profile",
                  "value": {
                    "shape": [
                      { "lat": 51.5322, "lon": -0.1240 },
                      { "lat": 51.5055, "lon": -0.0754 }
                    ],
                    "range": true,
                    "resample_distance": 50
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Elevation data with summary",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/ElevationResponse" } },
              "application/geo+json": { "schema": { "type": "object", "description": "GeoJSON FeatureCollection of Point features with 3D coordinates [lon, lat, elevation]." } }
            }
          },
          "400": { "description": "Invalid request", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "503": { "description": "Routing engine unavailable", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/v1/routing/optimize": {
      "post": {
        "operationId": "optimizeRoute",
        "summary": "Optimise visit order for multiple stops",
        "description": "Solve the travelling salesman problem: find the optimal order to visit locations. Returns the optimised route with terrain analytics and savings (distance and time) compared to the original order.",
        "tags": ["Routing"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/OptimizeRequest" },
              "examples": {
                "delivery": {
                  "summary": "Optimise delivery stops",
                  "value": {
                    "locations": [
                      { "lat": 51.5322, "lon": -0.1240 },
                      { "lat": 51.5055, "lon": -0.0754 },
                      { "lat": 51.5178, "lon": -0.0823 },
                      { "lat": 51.5055, "lon": -0.0862 }
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Optimised route with savings",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/OptimizeResponse" } },
              "application/geo+json": { "schema": { "type": "object", "description": "GeoJSON FeatureCollection of the optimised route. Same data as footstep format, different shape." } }
            }
          },
          "400": { "description": "Invalid request", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "503": { "description": "Routing engine unavailable", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/v1/routing/snap": {
      "post": {
        "operationId": "snapTrace",
        "summary": "Snap a GPS trace to the road network",
        "description": "Map-match a GPS trace to the road network. Returns a snapped polyline with confidence score. Optionally includes directions with terrain analytics, road attributes (surface, grade, road class), and per-point match quality.",
        "tags": ["Routing"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/SnapRequest" },
              "examples": {
                "basic": {
                  "summary": "Snap GPS trace to roads",
                  "value": {
                    "shape": [
                      { "lat": 51.5322, "lon": -0.1240 },
                      { "lat": 51.5013, "lon": -0.1228 },
                      { "lat": 51.5019, "lon": -0.1209 },
                      { "lat": 51.5025, "lon": -0.1190 }
                    ]
                  }
                },
                "with_attributes": {
                  "summary": "Get road details too",
                  "value": {
                    "shape": [
                      { "lat": 51.5322, "lon": -0.1240 },
                      { "lat": 51.5013, "lon": -0.1228 },
                      { "lat": 51.5019, "lon": -0.1209 }
                    ],
                    "output": "both",
                    "gps_accuracy": 10
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": { "description": "Snapped trace with optional route and attributes", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/SnapResponse" } } } },
          "400": { "description": "Invalid request", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "503": { "description": "Routing engine unavailable", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/v1/routing/isochrone": {
      "post": {
        "operationId": "calculateIsochrone",
        "summary": "Calculate reachability polygons",
        "description": "Generate time or distance-based reachability contours from a location. Default format returns structured contours with geometry. Use format=geojson for a standard GeoJSON FeatureCollection. Supports terrain-aware reachability via costing_options.",
        "tags": ["Analysis"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/IsochroneRequest" },
              "examples": {
                "time_based": {
                  "summary": "15-minute walking isochrone",
                  "value": {
                    "locations": [{ "lat": 51.5322, "lon": -0.1240 }],
                    "costing": "pedestrian",
                    "contours": [
                      { "time": 5, "color": "ff0000" },
                      { "time": 10, "color": "ffff00" },
                      { "time": 15, "color": "00ff00" }
                    ]
                  }
                },
                "distance_based": {
                  "summary": "5km cycling range",
                  "value": {
                    "locations": [{ "lat": 51.5322, "lon": -0.1240 }],
                    "costing": "bicycle",
                    "contours": [{ "distance": 5.0 }]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Isochrone contours",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/IsochroneResponse" } },
              "application/geo+json": { "schema": { "type": "object", "description": "GeoJSON FeatureCollection with polygon features for each contour. Properties include contour value, metric, and color." } }
            }
          },
          "400": { "description": "Invalid request", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "503": { "description": "Routing engine unavailable", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/v1/routing/matrix": {
      "post": {
        "operationId": "calculateMatrix",
        "summary": "Calculate time/distance matrix",
        "description": "Compute a time and distance matrix between sources and targets. Returns a 2D matrix indexed by [source][target] with distance_m and duration_s for each pair. Null cells indicate unreachable pairs. All distances are in meters regardless of request units.",
        "tags": ["Analysis"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/MatrixRequest" },
              "examples": {
                "basic": {
                  "summary": "2x2 distance matrix",
                  "value": {
                    "sources": [
                      { "lat": 51.5322, "lon": -0.1240 },
                      { "lat": 51.5055, "lon": -0.0754 }
                    ],
                    "targets": [
                      { "lat": 51.5178, "lon": -0.0823 },
                      { "lat": 51.5055, "lon": -0.0862 }
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Time/distance matrix",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/MatrixResponse" } },
              "application/geo+json": { "schema": { "type": "object", "description": "GeoJSON FeatureCollection where each source-target pair is a Feature with straight-line LineString geometry. Properties include distance_m, duration_s, and source/target indices." } }
            }
          },
          "400": { "description": "Invalid request", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "503": { "description": "Routing engine unavailable", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/v1/routing/locate": {
      "post": {
        "operationId": "locateOnRoad",
        "summary": "Snap coordinates to the nearest road",
        "description": "Check if coordinates are on a routable road and get the nearest snapped position. Returns distance, on-road status, and optionally edge metadata (road class, surface, speed).",
        "tags": ["Analysis"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/LocateRequest" },
              "examples": {
                "basic": {
                  "summary": "Check if points are on roads",
                  "value": {
                    "locations": [
                      { "lat": 51.5322, "lon": -0.1240 },
                      { "lat": 51.5055, "lon": -0.0754 }
                    ]
                  }
                },
                "verbose": {
                  "summary": "With road metadata",
                  "value": {
                    "locations": [{ "lat": 51.5322, "lon": -0.1240 }],
                    "verbose": true
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Locate results",
            "content": {
              "application/json": { "schema": { "$ref": "#/components/schemas/LocateResponse" } },
              "application/geo+json": { "schema": { "type": "object", "description": "GeoJSON FeatureCollection of Point features for each located point." } }
            }
          },
          "400": { "description": "Invalid request", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } },
          "503": { "description": "Routing engine unavailable", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/Error" } } } }
        }
      }
    },
    "/v1/routing/valhalla-status": {
      "get": {
        "operationId": "getValhallaStatus",
        "summary": "Check routing engine status",
        "description": "Check whether the Valhalla routing engine is configured and available.",
        "tags": ["System"],
        "responses": {
          "200": { "description": "Valhalla status", "content": { "application/json": { "schema": { "$ref": "#/components/schemas/ValhallaStatusResponse" } } } }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "apiKey": {
        "type": "apiKey",
        "in": "header",
        "name": "x-api-key",
        "description": "Your Footstep API key"
      }
    },
    "schemas": {
      "Coordinate": {
        "type": "object",
        "required": ["lat", "lon"],
        "properties": {
          "lat": { "type": "number", "minimum": -90, "maximum": 90 },
          "lon": { "type": "number", "minimum": -180, "maximum": 180 }
        }
      },
      "Format": {
        "type": "string",
        "enum": ["footstep", "geojson"],
        "default": "footstep",
        "description": "Response format. footstep = optimised for app developers (encoded polyline, flat structure). geojson = standard GeoJSON FeatureCollection (decoded coordinates, immediately usable in Leaflet/Mapbox GL/deck.gl)."
      },
      "CostingOptions": {
        "type": "object",
        "description": "Mode-specific tuning. Include only the key matching your costing mode.",
        "properties": {
          "auto": {
            "type": "object",
            "properties": {
              "use_highways": { "type": "number", "minimum": 0, "maximum": 1, "description": "0 = avoid, 1 = prefer" },
              "use_tolls": { "type": "number", "minimum": 0, "maximum": 1 },
              "use_ferry": { "type": "number", "minimum": 0, "maximum": 1 },
              "height": { "type": "number", "description": "Vehicle height in meters" },
              "width": { "type": "number", "description": "Vehicle width in meters" },
              "weight": { "type": "number", "description": "Vehicle weight in tonnes" }
            }
          },
          "pedestrian": {
            "type": "object",
            "properties": {
              "use_hills": { "type": "number", "minimum": 0, "maximum": 1, "description": "0 = avoid hills, 1 = prefer hills" },
              "walking_speed": { "type": "number", "minimum": 0.5, "maximum": 25, "description": "Speed in km/h" },
              "max_hiking_difficulty": { "type": "number", "minimum": 0, "maximum": 6, "description": "SAC hiking scale (0-6)" },
              "use_lit": { "type": "number", "minimum": 0, "maximum": 1, "description": "Prefer lit streets" },
              "step_penalty": { "type": "number", "description": "Seconds penalty per stair transition" }
            }
          },
          "bicycle": {
            "type": "object",
            "properties": {
              "use_hills": { "type": "number", "minimum": 0, "maximum": 1, "description": "0 = avoid hills, 1 = prefer hills" },
              "cycling_speed": { "type": "number", "minimum": 5, "maximum": 50, "description": "Speed in km/h" },
              "bicycle_type": { "type": "string", "enum": ["road", "hybrid", "cross", "mountain"] },
              "use_roads": { "type": "number", "minimum": 0, "maximum": 1 },
              "avoid_bad_surfaces": { "type": "number", "minimum": 0, "maximum": 1 }
            }
          },
          "truck": {
            "type": "object",
            "properties": {
              "use_highways": { "type": "number", "minimum": 0, "maximum": 1 },
              "use_tolls": { "type": "number", "minimum": 0, "maximum": 1 },
              "height": { "type": "number", "description": "Vehicle height in meters" },
              "width": { "type": "number", "description": "Vehicle width in meters" },
              "weight": { "type": "number", "description": "Vehicle weight in tonnes" },
              "hazmat": { "type": "boolean" },
              "axle_load": { "type": "number", "description": "Axle load in tonnes" }
            }
          }
        }
      },
      "BoundingBox": {
        "type": "object",
        "required": ["min_lat", "min_lon", "max_lat", "max_lon"],
        "properties": {
          "min_lat": { "type": "number" },
          "min_lon": { "type": "number" },
          "max_lat": { "type": "number" },
          "max_lon": { "type": "number" }
        },
        "description": "Bounding box for map.fitBounds()"
      },
      "RouteFlags": {
        "type": "object",
        "required": ["has_toll", "has_highway", "has_ferry"],
        "properties": {
          "has_toll": { "type": "boolean" },
          "has_highway": { "type": "boolean" },
          "has_ferry": { "type": "boolean" }
        }
      },
      "StepFlags": {
        "type": "object",
        "required": ["toll", "ferry", "rough", "gate", "highway"],
        "properties": {
          "toll": { "type": "boolean" },
          "ferry": { "type": "boolean" },
          "rough": { "type": "boolean" },
          "gate": { "type": "boolean" },
          "highway": { "type": "boolean" }
        }
      },
      "StepType": {
        "type": "string",
        "enum": [
          "none", "start", "start_right", "start_left",
          "destination", "destination_right", "destination_left",
          "becomes", "continue",
          "slight_right", "right", "sharp_right",
          "u_turn_right", "u_turn_left",
          "sharp_left", "left", "slight_left",
          "ramp_straight", "ramp_right", "ramp_left",
          "exit_right", "exit_left",
          "stay_straight", "stay_right", "stay_left",
          "merge", "roundabout_enter", "roundabout_exit",
          "ferry_enter", "ferry_exit",
          "transit", "transit_transfer", "transit_remain_on",
          "transit_connection_start", "transit_connection_transfer",
          "transit_connection_destination", "post_transit_connection_destination",
          "merge_right", "merge_left",
          "unknown"
        ],
        "description": "Human-readable step type (e.g. slight_right, roundabout_enter)"
      },
      "ExitSign": {
        "type": "object",
        "properties": {
          "exit_number": { "type": "string" },
          "exit_branch": { "type": "string" },
          "exit_toward": { "type": "string" },
          "exit_name": { "type": "string" }
        },
        "description": "Highway exit sign information"
      },
      "Lane": {
        "type": "object",
        "required": ["indications", "valid"],
        "properties": {
          "indications": { "type": "array", "items": { "type": "string" } },
          "valid": { "type": "boolean" },
          "active": { "type": "boolean" }
        }
      },
      "Step": {
        "type": "object",
        "required": ["type", "instruction", "street_names", "distance_m", "duration_s", "begin_shape_index", "end_shape_index", "travel_mode", "flags"],
        "description": "A turn-by-turn navigation step",
        "properties": {
          "type": { "$ref": "#/components/schemas/StepType" },
          "instruction": { "type": "string", "description": "Human-readable navigation instruction" },
          "verbal_alert": { "type": "string", "description": "Spoken alert before the step" },
          "verbal_instruction": { "type": "string", "description": "Spoken instruction at the step" },
          "street_names": { "type": "array", "items": { "type": "string" }, "description": "Street name(s) for this step" },
          "distance_m": { "type": "number", "description": "Step distance in meters" },
          "duration_s": { "type": "number", "description": "Step duration in seconds" },
          "begin_shape_index": { "type": "number", "description": "Index into the leg shape where this step starts" },
          "end_shape_index": { "type": "number", "description": "Index into the leg shape where this step ends" },
          "travel_mode": { "type": "string", "description": "Mode of travel: drive, pedestrian, bicycle, transit" },
          "bearing_before": { "type": "number", "description": "Bearing in degrees approaching the step (0-360)" },
          "bearing_after": { "type": "number", "description": "Bearing in degrees leaving the step (0-360)" },
          "flags": { "$ref": "#/components/schemas/StepFlags" },
          "roundabout_exit_count": { "type": "number", "description": "Which exit to take in a roundabout" },
          "exit_sign": { "$ref": "#/components/schemas/ExitSign" },
          "lanes": { "type": "array", "items": { "$ref": "#/components/schemas/Lane" }, "description": "Lane guidance at the step" }
        }
      },
      "TerrainSummary": {
        "type": "object",
        "description": "Terrain analytics computed from elevation data. Included automatically in routing responses.",
        "required": ["total_ascent_m", "total_descent_m", "max_elevation_m", "min_elevation_m", "avg_grade_percent", "max_grade_percent", "elevation_profile", "difficulty"],
        "properties": {
          "total_ascent_m": { "type": "number", "description": "Total uphill gain in meters" },
          "total_descent_m": { "type": "number", "description": "Total downhill loss in meters" },
          "max_elevation_m": { "type": "number", "description": "Highest point" },
          "min_elevation_m": { "type": "number", "description": "Lowest point" },
          "avg_grade_percent": { "type": "number", "description": "Average absolute grade %" },
          "max_grade_percent": { "type": "number", "description": "Maximum absolute grade %" },
          "elevation_profile": {
            "type": "array",
            "description": "Sampled elevation profile for charting",
            "items": { "type": "object", "required": ["distance_m", "elevation_m"], "properties": { "distance_m": { "type": "number" }, "elevation_m": { "type": "number" } } }
          },
          "difficulty": { "type": "string", "enum": ["flat", "rolling", "hilly", "mountainous"], "description": "Terrain difficulty classification based on grade distribution" }
        }
      },
      "Waypoint": {
        "type": "object",
        "required": ["lat", "lon"],
        "properties": {
          "lat": { "type": "number" },
          "lon": { "type": "number" },
          "original_index": { "type": "number", "description": "Original input index (present in optimise responses)" }
        }
      },
      "Leg": {
        "type": "object",
        "required": ["distance_m", "duration_s", "shape", "steps", "terrain", "flags", "bounds"],
        "description": "A route leg between two waypoints",
        "properties": {
          "distance_m": { "type": "number", "description": "Leg distance in meters" },
          "duration_s": { "type": "number", "description": "Leg duration in seconds" },
          "shape": { "type": "string", "description": "Encoded polyline6 geometry" },
          "steps": { "type": "array", "items": { "$ref": "#/components/schemas/Step" }, "description": "Turn-by-turn navigation steps" },
          "terrain": { "$ref": "#/components/schemas/TerrainSummary" },
          "flags": { "$ref": "#/components/schemas/RouteFlags" },
          "bounds": { "$ref": "#/components/schemas/BoundingBox" }
        }
      },
      "Route": {
        "type": "object",
        "required": ["waypoints", "legs", "distance_m", "duration_s", "flags", "bounds", "terrain", "units"],
        "description": "A complete route with terrain analytics",
        "properties": {
          "waypoints": { "type": "array", "items": { "$ref": "#/components/schemas/Waypoint" } },
          "legs": { "type": "array", "items": { "$ref": "#/components/schemas/Leg" } },
          "distance_m": { "type": "number", "description": "Total route distance in meters" },
          "duration_s": { "type": "number", "description": "Total route duration in seconds" },
          "flags": { "$ref": "#/components/schemas/RouteFlags" },
          "bounds": { "$ref": "#/components/schemas/BoundingBox" },
          "terrain": { "$ref": "#/components/schemas/TerrainSummary" },
          "units": { "type": "string", "description": "Echo of request units (informational only â€” response values are always in meters/seconds)" }
        }
      },
      "ElevationSummary": {
        "type": "object",
        "required": ["total_ascent_m", "total_descent_m", "max_elevation_m", "min_elevation_m", "avg_elevation_m"],
        "properties": {
          "total_ascent_m": { "type": "number" },
          "total_descent_m": { "type": "number" },
          "max_elevation_m": { "type": "number" },
          "min_elevation_m": { "type": "number" },
          "avg_elevation_m": { "type": "number" }
        }
      },
      "Error": {
        "type": "object",
        "required": ["error", "message"],
        "properties": {
          "error": { "type": "string" },
          "message": { "type": "string" }
        }
      },
      "RouteRequest": {
        "type": "object",
        "required": ["locations"],
        "properties": {
          "locations": { "type": "array", "items": { "$ref": "#/components/schemas/Coordinate" }, "minItems": 2, "maxItems": 20, "description": "Waypoints (min 2, max 20)" },
          "costing": { "type": "string", "enum": ["auto", "bicycle", "pedestrian", "bus", "truck"], "default": "auto", "description": "Transport mode" },
          "costing_options": { "$ref": "#/components/schemas/CostingOptions" },
          "units": { "type": "string", "enum": ["kilometers", "miles"], "default": "kilometers" },
          "language": { "type": "string", "default": "en-GB", "description": "Language for instructions" },
          "elevation_interval": { "type": "number", "minimum": 10, "maximum": 200, "default": 30, "description": "Elevation sampling interval in meters" },
          "alternates": { "type": "number", "minimum": 0, "maximum": 3, "default": 0, "description": "Number of alternate routes" },
          "format": { "$ref": "#/components/schemas/Format" }
        }
      },
      "RouteResponse": {
        "type": "object",
        "required": ["route"],
        "properties": {
          "route": { "$ref": "#/components/schemas/Route" },
          "alternates": { "type": "array", "items": { "$ref": "#/components/schemas/Route" }, "description": "Alternate routes (same shape as primary route)" }
        }
      },
      "ElevationRequest": {
        "type": "object",
        "description": "Provide either shape or encoded_polyline",
        "properties": {
          "shape": { "type": "array", "items": { "$ref": "#/components/schemas/Coordinate" }, "maxItems": 2000, "description": "Coordinates (max 2000)" },
          "encoded_polyline": { "type": "string", "description": "Encoded polyline alternative" },
          "range": { "type": "boolean", "default": false, "description": "Include cumulative distances" },
          "resample_distance": { "type": "number", "minimum": 1, "maximum": 1000, "description": "Resample interval in meters" },
          "height_precision": { "type": "number", "minimum": 0, "maximum": 2, "default": 0, "description": "Decimal places for heights" },
          "format": { "$ref": "#/components/schemas/Format" }
        }
      },
      "ElevationResponse": {
        "type": "object",
        "properties": {
          "shape": { "type": "array", "items": { "$ref": "#/components/schemas/Coordinate" } },
          "height": { "type": "array", "items": { "type": "number" }, "description": "Elevations (when range=false)" },
          "range_height": { "type": "array", "items": { "type": "array", "items": { "type": "number" }, "minItems": 2, "maxItems": 2 }, "description": "[distance_m, elevation_m] tuples (when range=true)" },
          "summary": { "$ref": "#/components/schemas/ElevationSummary" }
        }
      },
      "OptimizeRequest": {
        "type": "object",
        "required": ["locations"],
        "properties": {
          "locations": { "type": "array", "items": { "$ref": "#/components/schemas/Coordinate" }, "minItems": 4, "maxItems": 50, "description": "Locations (min 4 for TSP)" },
          "costing": { "type": "string", "enum": ["auto", "bicycle", "pedestrian"], "default": "auto" },
          "costing_options": { "$ref": "#/components/schemas/CostingOptions" },
          "units": { "type": "string", "enum": ["kilometers", "miles"], "default": "kilometers" },
          "elevation_interval": { "type": "number", "minimum": 10, "maximum": 200, "default": 30 },
          "format": { "$ref": "#/components/schemas/Format" }
        }
      },
      "OptimizeResponse": {
        "type": "object",
        "required": ["route", "optimized_order", "savings"],
        "properties": {
          "route": { "$ref": "#/components/schemas/Route" },
          "optimized_order": { "type": "array", "items": { "type": "number" }, "description": "Original location indices in optimised visit order" },
          "savings": {
            "type": "object",
            "required": ["distance_saved_m", "distance_saved_percent", "time_saved_s", "time_saved_percent"],
            "description": "Savings compared to original location order",
            "properties": {
              "distance_saved_m": { "type": "number", "description": "Distance saved in meters" },
              "distance_saved_percent": { "type": "number", "description": "Percentage of distance saved" },
              "time_saved_s": { "type": "number", "description": "Time saved in seconds" },
              "time_saved_percent": { "type": "number", "description": "Percentage of time saved" }
            }
          }
        }
      },
      "SnapRequest": {
        "type": "object",
        "description": "Provide either shape or encoded_polyline",
        "properties": {
          "shape": {
            "type": "array",
            "items": { "type": "object", "required": ["lat", "lon"], "properties": { "lat": { "type": "number" }, "lon": { "type": "number" }, "time": { "type": "number", "description": "Unix timestamp" }, "accuracy": { "type": "number", "description": "GPS accuracy in meters" } } },
            "minItems": 2,
            "maxItems": 20000
          },
          "encoded_polyline": { "type": "string" },
          "costing": { "type": "string", "enum": ["auto", "bicycle", "pedestrian", "bus", "truck"], "default": "auto" },
          "output": { "type": "string", "enum": ["route", "attributes", "both"], "default": "route", "description": "route = directions with terrain, attributes = road details, both = combined" },
          "gps_accuracy": { "type": "number", "minimum": 1, "maximum": 100, "default": 5, "description": "GPS accuracy in meters" },
          "search_radius": { "type": "number", "minimum": 1, "maximum": 100, "default": 25, "description": "Search radius in meters" },
          "elevation_interval": { "type": "number", "minimum": 10, "maximum": 200, "default": 30 },
          "format": { "$ref": "#/components/schemas/Format" }
        }
      },
      "SnapResponse": {
        "type": "object",
        "required": ["snapped_shape", "confidence"],
        "properties": {
          "snapped_shape": { "type": "string", "description": "Encoded polyline of snapped trace" },
          "confidence": { "type": "number", "minimum": 0, "maximum": 1, "description": "Match confidence score (0-1)" },
          "route": {
            "type": "object",
            "description": "Present when output includes 'route'. Includes terrain analytics.",
            "properties": {
              "legs": { "type": "array", "items": { "$ref": "#/components/schemas/Leg" } },
              "distance_m": { "type": "number", "description": "Total distance in meters" },
              "duration_s": { "type": "number", "description": "Total duration in seconds" },
              "terrain": { "$ref": "#/components/schemas/TerrainSummary" }
            }
          },
          "edges": {
            "type": "array",
            "description": "Present when output includes 'attributes'. Road segment details.",
            "items": {
              "type": "object",
              "required": ["names", "length_m"],
              "properties": {
                "names": { "type": "array", "items": { "type": "string" }, "description": "Road name(s)" },
                "length_m": { "type": "number", "description": "Edge length in meters" },
                "speed_kph": { "type": "number", "description": "Speed limit in km/h" },
                "road_class": { "type": "string", "description": "Road classification (motorway, primary, secondary, etc.)" },
                "surface": { "type": "string", "description": "Road surface type (paved_smooth, paved, gravel, etc.)" },
                "grade_percent": { "type": "number", "description": "Grade as a percentage" }
              }
            }
          },
          "matched_points": {
            "type": "array",
            "description": "Per-point match quality details",
            "items": {
              "type": "object",
              "required": ["lat", "lon", "type", "distance_from_trace_m", "edge_index"],
              "properties": {
                "lat": { "type": "number" },
                "lon": { "type": "number" },
                "type": { "type": "string", "enum": ["matched", "interpolated", "unmatched"] },
                "distance_from_trace_m": { "type": "number", "description": "Distance from original trace point in meters" },
                "edge_index": { "type": "number", "description": "Index into the edges array" }
              }
            }
          }
        }
      },
      "IsochroneRequest": {
        "type": "object",
        "required": ["locations", "contours"],
        "properties": {
          "locations": { "type": "array", "items": { "$ref": "#/components/schemas/Coordinate" }, "minItems": 1, "maxItems": 1, "description": "Single origin" },
          "costing": { "type": "string", "enum": ["auto", "bicycle", "pedestrian", "bus", "truck"], "default": "pedestrian" },
          "costing_options": { "$ref": "#/components/schemas/CostingOptions" },
          "contours": { "type": "array", "minItems": 1, "maxItems": 4, "items": { "type": "object", "description": "Provide time (minutes) or distance (km)", "properties": { "time": { "type": "number", "minimum": 1, "maximum": 120 }, "distance": { "type": "number", "minimum": 0.1, "maximum": 200 }, "color": { "type": "string" } } } },
          "polygons": { "type": "boolean", "default": true },
          "denoise": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.5, "description": "0 = detailed, 1 = smoothed" },
          "show_locations": { "type": "boolean", "default": false },
          "format": { "$ref": "#/components/schemas/Format" }
        }
      },
      "IsochroneResponse": {
        "type": "object",
        "required": ["origin", "costing", "contours"],
        "description": "Structured isochrone response with typed contours",
        "properties": {
          "origin": { "$ref": "#/components/schemas/Coordinate" },
          "costing": { "type": "string", "description": "Transport mode used" },
          "contours": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["metric", "value", "geometry"],
              "properties": {
                "metric": { "type": "string", "enum": ["time", "distance"], "description": "Whether this contour is time or distance based" },
                "value": { "type": "number", "description": "Contour value (minutes or km)" },
                "geometry": {
                  "type": "object",
                  "description": "GeoJSON geometry of the contour",
                  "properties": {
                    "type": { "type": "string", "enum": ["Polygon", "LineString"] },
                    "coordinates": { "description": "Coordinate arrays" }
                  }
                }
              }
            }
          }
        }
      },
      "MatrixRequest": {
        "type": "object",
        "required": ["sources", "targets"],
        "properties": {
          "sources": { "type": "array", "items": { "$ref": "#/components/schemas/Coordinate" }, "minItems": 1, "maxItems": 50 },
          "targets": { "type": "array", "items": { "$ref": "#/components/schemas/Coordinate" }, "minItems": 1, "maxItems": 50 },
          "costing": { "type": "string", "enum": ["auto", "bicycle", "pedestrian", "bus", "truck"], "default": "auto" },
          "costing_options": { "$ref": "#/components/schemas/CostingOptions" },
          "units": { "type": "string", "enum": ["kilometers", "miles"], "default": "kilometers" },
          "format": { "$ref": "#/components/schemas/Format" }
        }
      },
      "MatrixResponse": {
        "type": "object",
        "required": ["sources", "targets", "matrix"],
        "description": "Time/distance matrix with explicit units",
        "properties": {
          "sources": { "type": "array", "items": { "$ref": "#/components/schemas/Coordinate" }, "description": "Flattened source coordinates" },
          "targets": { "type": "array", "items": { "$ref": "#/components/schemas/Coordinate" }, "description": "Flattened target coordinates" },
          "matrix": {
            "type": "array",
            "description": "2D matrix indexed as matrix[source_index][target_index]. null = unreachable pair.",
            "items": {
              "type": "array",
              "items": {
                "oneOf": [
                  {
                    "type": "object",
                    "required": ["distance_m", "duration_s"],
                    "properties": {
                      "distance_m": { "type": "number", "description": "Distance in meters" },
                      "duration_s": { "type": "number", "description": "Duration in seconds" }
                    }
                  },
                  { "type": "null" }
                ]
              }
            }
          }
        }
      },
      "LocateRequest": {
        "type": "object",
        "required": ["locations"],
        "properties": {
          "locations": { "type": "array", "items": { "$ref": "#/components/schemas/Coordinate" }, "minItems": 1, "maxItems": 100 },
          "costing": { "type": "string", "enum": ["auto", "bicycle", "pedestrian", "bus", "truck"], "default": "auto", "description": "Filter edges by mode" },
          "verbose": { "type": "boolean", "default": false, "description": "Include edge metadata" },
          "format": { "$ref": "#/components/schemas/Format" }
        }
      },
      "LocateResponse": {
        "type": "object",
        "required": ["locations"],
        "properties": {
          "locations": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["input", "distance_m", "on_road"],
              "properties": {
                "input": { "$ref": "#/components/schemas/Coordinate" },
                "snapped": { "$ref": "#/components/schemas/Coordinate", "description": "Snapped position (absent if not near road)" },
                "distance_m": { "type": "number", "description": "Distance to nearest road in meters" },
                "on_road": { "type": "boolean", "description": "Whether near a routable road" },
                "edges": {
                  "type": "array",
                  "description": "Present when verbose=true",
                  "items": {
                    "type": "object",
                    "required": ["names"],
                    "properties": {
                      "names": { "type": "array", "items": { "type": "string" } },
                      "road_class": { "type": "string" },
                      "speed_kph": { "type": "number" },
                      "surface": { "type": "string" },
                      "elevation_m": { "type": "number" }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "ValhallaStatusResponse": {
        "type": "object",
        "properties": {
          "configured": { "type": "boolean" },
          "available": { "type": "boolean" },
          "version": { "type": "string" }
        }
      }
    }
  }
}
